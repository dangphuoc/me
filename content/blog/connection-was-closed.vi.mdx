---
title: Connection Was Closed - Khi má»™t dÃ²ng code phÃ¡ vá»¡ cáº£ há»‡ thá»‘ng
excerpt: HÃ nh trÃ¬nh debug Ä‘Ãªm GiÃ¡ng sinh vÃ  bÃ i há»c vá» HTTP Keep-Alive, Connection Pooling. Táº¡i sao response.close() cÃ³ thá»ƒ giáº¿t cháº¿t hÃ ng nghÃ¬n request?
date: 2024-12-25
tags:
  - HTTP
  - Connection Pool
  - Keep-Alive
  - Debugging
  - Vert.x
thumbnail: https://images.unsplash.com/photo-1504639725590-34d0984388bd?w=800
---

# Connection Was Closed - Khi má»™t dÃ²ng code phÃ¡ vá»¡ cáº£ há»‡ thá»‘ng

SÃ¡u giá» tá»‘i ngÃ y 24 thÃ¡ng 12. Thay vÃ¬ chuáº©n bá»‹ tiá»‡c GiÃ¡ng sinh, team chÃºng tÃ´i Ä‘ang nhÃ¬n cháº±m cháº±m vÃ o mÃ n hÃ¬nh monitoring. HÃ ng nghÃ¬n giao dá»‹ch Ä‘ang fail vá»›i cÃ¹ng má»™t thÃ´ng bÃ¡o: **"Connection was closed"**.

Há»‡ thá»‘ng nÃ y Ä‘Ã£ cháº¡y á»•n Ä‘á»‹nh suá»‘t 4 thÃ¡ng tÃ­ch há»£p. Thá»‰nh thoáº£ng cÃ³ lá»—i tÆ°Æ¡ng tá»± trong UAT, nhÆ°ng ai cÅ©ng nghÄ© Ä‘Ã³ lÃ  váº¥n Ä‘á» háº¡ táº§ng - restart lÃ  xong. ÄÃªm hÃ´m Ä‘Ã³, chÃºng tÃ´i nháº­n ra mÃ¬nh Ä‘Ã£ sai.

![Debugging](https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800)

---

## Manh má»‘i Ä‘áº§u tiÃªn

Khoáº£ng ná»­a Ä‘Ãªm, sau khi loáº¡i trá»« Ä‘á»§ thá»© tá»« Kubernetes Ä‘áº¿n sidecar, má»™t anh trong team nháº­n ra Ä‘iá»u ká»³ láº¡: *"Máº¥y request Ä‘áº§u khÃ´ng lá»—i. Sau má»™t khoáº£ng thá»i gian má»›i báº¯t Ä‘áº§u lá»—i."*

CÃ¢u nÃ y khiáº¿n tÃ´i dá»«ng láº¡i suy nghÄ©. Náº¿u lÃ  váº¥n Ä‘á» háº¡ táº§ng, lá»—i pháº£i xáº£y ra ngáº«u nhiÃªn hoáº·c ngay tá»« Ä‘áº§u. NhÆ°ng pattern "request Ä‘áº§u OK, request sau fail" gá»£i Ã½ cÃ³ thá»© gÃ¬ Ä‘Ã³ Ä‘ang **tÃ­ch lÅ©y**.

VÃ  rá»“i má»™t anh khÃ¡c chá»‘t háº¡ lÃºc 12:55 AM: *"Issue server close connection lÃ  client submit lÃªn lÃ  nÃ³ vÄƒng exception ngay láº­p tá»©c. KhÃ´ng pháº£i Ä‘á»£i má»™t há»“i."*

**Ngay láº­p tá»©c.** KhÃ´ng pháº£i timeout. ÄÃ¢y lÃ  manh má»‘i quan trá»ng nháº¥t.

---

## CÃ¢u chuyá»‡n vá» nhá»¯ng cÃ¡i báº¯t tay

Äá»ƒ hiá»ƒu váº¥n Ä‘á», tÃ´i cáº§n ká»ƒ cho báº¡n má»™t cÃ¢u chuyá»‡n vá» cÃ¡ch mÃ¡y tÃ­nh "nÃ³i chuyá»‡n" vá»›i nhau.

HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n gá»i Ä‘iá»‡n cho ai Ä‘Ã³. TrÆ°á»›c khi nÃ³i chuyá»‡n, báº¡n pháº£i chá» há» nháº¥c mÃ¡y, nÃ³i "AlÃ´", rá»“i báº¡n Ä‘Ã¡p láº¡i. ÄÃ³ lÃ  **báº¯t tay** - má»™t nghi thá»©c cáº§n thiáº¿t trÆ°á»›c khi trao Ä‘á»•i thÃ´ng tin.

TCP connection cÅ©ng váº­y. Má»—i láº§n client muá»‘n gá»­i request Ä‘áº¿n server, chÃºng pháº£i "báº¯t tay" trÆ°á»›c:

```
Client: "TÃ´i muá»‘n káº¿t ná»‘i" (SYN)
Server: "OK, tÃ´i sáºµn sÃ ng" (SYN-ACK)
Client: "Tuyá»‡t, báº¯t Ä‘áº§u nhÃ©" (ACK)
```

Nghe cÃ³ váº» Ä‘Æ¡n giáº£n, nhÆ°ng má»—i láº§n báº¯t tay tá»‘n khoáº£ng **1.5 vÃ²ng Ä‘i-vá»** qua máº¡ng. Vá»›i server á»Ÿ Singapore vÃ  client á»Ÿ Viá»‡t Nam, má»—i vÃ²ng máº¥t ~50ms. NghÄ©a lÃ  má»—i láº§n báº¯t tay tá»‘n ~75ms.

BÃ¢y giá» tÆ°á»Ÿng tÆ°á»£ng báº¡n cÃ³ 100 requests. Náº¿u má»—i request pháº£i báº¯t tay riÃªng, báº¡n máº¥t **7.5 giÃ¢y** chá»‰ Ä‘á»ƒ... chÃ o há»i. ChÆ°a lÃ m gÃ¬ cáº£.

### Giáº£i phÃ¡p: Giá»¯ Ä‘Æ°á»ng dÃ¢y

VÃ o nÄƒm 1997, nhá»¯ng ngÆ°á»i thiáº¿t káº¿ HTTP/1.1 nghÄ© ra má»™t Ã½ tÆ°á»Ÿng Ä‘Æ¡n giáº£n: **Táº¡i sao pháº£i cÃºp mÃ¡y sau má»—i cÃ¢u há»i?**

Thay vÃ¬:
- Gá»i â†’ Há»i â†’ CÃºp mÃ¡y
- Gá»i â†’ Há»i â†’ CÃºp mÃ¡y
- Gá»i â†’ Há»i â†’ CÃºp mÃ¡y

Há» Ä‘á» xuáº¥t:
- Gá»i â†’ Há»i â†’ Há»i tiáº¿p â†’ Há»i tiáº¿p â†’ ... â†’ Xong rá»“i cÃºp

ÄÃ¢y chÃ­nh lÃ  **HTTP Keep-Alive**. Má»™t connection Ä‘Æ°á»£c giá»¯ má»Ÿ Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng cho nhiá»u requests. 100 requests giá» chá»‰ cáº§n **má»™t láº§n** báº¯t tay.

---

## Connection Pool - Khi hiá»‡u quáº£ gáº·p phá»©c táº¡p

CÃ¡c ká»¹ sÆ° Ä‘i xa hÆ¡n ná»¯a. Há» nghÄ©: *"Náº¿u Keep-Alive tá»‘t, táº¡i sao khÃ´ng chuáº©n bá»‹ sáºµn nhiá»u connections?"*

Giá»‘ng nhÆ° má»™t nhÃ  hÃ ng khÃ´ng Ä‘á»£i khÃ¡ch Ä‘áº¿n má»›i rá»­a bÃ¡t. Há» chuáº©n bá»‹ sáºµn má»™t tá»§ bÃ¡t sáº¡ch. KhÃ¡ch Ä‘áº¿n, láº¥y bÃ¡t ra dÃ¹ng. KhÃ¡ch Äƒn xong, rá»­a sáº¡ch, cáº¥t láº¡i tá»§. KhÃ¡ch tiáº¿p theo láº¥y ra dÃ¹ng tiáº¿p.

**Connection Pool** hoáº¡t Ä‘á»™ng y há»‡t:

1. Khá»Ÿi Ä‘á»™ng: Táº¡o sáºµn 10-20 connections Ä‘áº¿n server
2. Cáº§n gá»­i request: Láº¥y 1 connection tá»« "tá»§"
3. Nháº­n response xong: Tráº£ connection vá» "tá»§"
4. Request tiáº¿p theo: Láº¥y connection cÃ³ sáºµn, khÃ´ng cáº§n táº¡o má»›i

Hiá»‡u quáº£ vÃ´ cÃ¹ng. NhÆ°ng cÃ³ má»™t giáº£ Ä‘á»‹nh ngáº§m mÃ  ai cÅ©ng quÃªn: **BÃ¡t trong tá»§ pháº£i cÃ²n sáº¡ch vÃ  nguyÃªn váº¹n.**

Äiá»u gÃ¬ xáº£y ra náº¿u ai Ä‘Ã³ lÃ©n Ä‘áº­p vá»¡ cÃ¡i bÃ¡t rá»“i cáº¥t láº¡i tá»§? NgÆ°á»i tiáº¿p theo láº¥y ra... bÃ¹m.

---

## Káº» phÃ¡ hoáº¡i tháº§m láº·ng

Quay láº¡i cÃ¢u chuyá»‡n debug. LÃºc 12:55 AM, khi anh Hiáº¿u nÃ³i *"exception ngay láº­p tá»©c"*, tÃ´i báº¯t Ä‘áº§u hÃ¬nh dung ra váº¥n Ä‘á».

Náº¿u client gá»­i request vÃ  server tráº£ lá»—i timeout, client sáº½ Ä‘á»£i. NhÆ°ng client khÃ´ng Ä‘á»£i - nÃ³ **vÄƒng lá»—i ngay**. Äiá»u nÃ y chá»‰ xáº£y ra khi connection **Ä‘Ã£ cháº¿t tá»« trÆ°á»›c**.

TÃ´i nghÄ©: *Server cá»§a mÃ¬nh Ä‘ang lÃ m gÃ¬ Ä‘Ã³ giáº¿t cháº¿t connection. Client khÃ´ng biáº¿t, váº«n cáº¥t connection "cháº¿t" vÃ o pool. Request sau láº¥y ra dÃ¹ng, bÃ¹m.*

Anh Hiáº¿u diá»…n Ä‘áº¡t chÃ­nh xÃ¡c hÆ¡n: *"Request A xá»­ lÃ½ xong rá»“i close. Client ngÃ¢y thÆ¡ khÃ´ng biáº¿t mÃ¬nh bá»‹ 'Ä‘Ã¡'. Váº«n vui váº» láº¥y connection Ä‘Ã³ xá»­ lÃ½ cho request B. VÃ  rá»“i... Request B lá»—i."*

ÄÃºng. ChÃ­nh xÃ¡c. Giá» chá»‰ cáº§n tÃ¬m code nÃ o Ä‘ang "close".

---

## Thá»§ pháº¡m lá»™ diá»‡n

1 giá» sÃ¡ng. TÃ´i grep codebase tÃ¬m `close()`. VÃ  tÃ´i tháº¥y nÃ³:

```java
HttpServerResponse response = request.response();
response.end(result);
response.close();  // â† ÄÃ¢y rá»“i!
```

XÃ³a dÃ²ng `response.close()`, cháº¡y test. Báº¯n 100 requests. 1000 requests. 10000 requests.

*"Báº¯n 2 nÄƒm rá»“i chÆ°a lá»—i"* - tÃ´i Ä‘Ã¹a trong group chat.

### NhÆ°ng khoan, táº¡i sao `close()` láº¡i cÃ³ háº¡i?

ÄÃ¢y lÃ  Ä‘iá»u nhiá»u developer khÃ´ng hiá»ƒu rÃµ. Trong Vert.x (vÃ  háº§u háº¿t HTTP frameworks), cÃ³ hai methods dá»… nháº§m láº«n:

**`response.end()`** - "TÃ´i Ä‘Ã£ gá»­i xong response"
- Server gá»­i data vá» client
- NhÆ°ng **giá»¯ connection má»Ÿ**
- Sáºµn sÃ ng nháº­n request tiáº¿p theo qua cÃ¹ng connection

**`response.close()`** - "TÃ´i muá»‘n Ä‘Ã³ng Ä‘Æ°á»ng dÃ¢y"
- ÄÃ³ng TCP connection ngay láº­p tá»©c
- Client khÃ´ng nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o
- Connection trong pool trá»Ÿ thÃ nh "xÃ¡c cháº¿t"

Developer viáº¿t code Ä‘Ã³ cÃ³ láº½ nghÄ©: *"Xong viá»‡c thÃ¬ dá»n dáº¹p cho sáº¡ch"*. Logic cÃ³ váº» Ä‘Ãºng. NhÆ°ng vá»›i HTTP Keep-Alive, `end()` Ä‘Ã£ lÃ  "dá»n dáº¹p" rá»“i. Gá»i thÃªm `close()` lÃ  **phÃ¡ hoáº¡i**.

---

## Sequence cá»§a tháº£m há»a

Äá»ƒ báº¡n hÃ¬nh dung rÃµ hÆ¡n, Ä‘Ã¢y lÃ  nhá»¯ng gÃ¬ xáº£y ra:

![Connection Closed Sequence](https://mermaid.ink/img/c2VxdWVuY2VEaWFncmFtCiAgICBwYXJ0aWNpcGFudCBDIGFzIENsaWVudDxicj4oQ29ubmVjdGlvbiBQb29sKQogICAgcGFydGljaXBhbnQgQ09OTiBhcyBUQ1AgQ29ubmVjdGlvbgogICAgcGFydGljaXBhbnQgUyBhcyBTZXJ2ZXIKICAgIAogICAgTm90ZSBvdmVyIEMsUzogUmVxdWVzdCAxIC0gVGjDoG5oIGPDtG5nCiAgICBDLT4+Q09OTjogTOG6pXkgY29ubmVjdGlvbiB04burIHBvb2wKICAgIENPTk4tPj5TOiBIVFRQIFJlcXVlc3QgMQogICAgUy0tPj5DT05OOiBIVFRQIFJlc3BvbnNlIDEKICAgIFMteCBDT05OOiByZXNwb25zZS5jbG9zZSgpIOKGkiBDbG9zZSBUQ1AKICAgIEMtPj5DT05OOiBUcuG6oyB24buBIHBvb2wgKHTGsOG7n25nIGPDsm4gc+G7kW5nKQogICAgCiAgICBOb3RlIG92ZXIgQyxTOiBSZXF1ZXN0IDIgLSBM4buXaSEKICAgIEMtPj5DT05OOiBMYXkgY29ubmVjdGlvbiB04burIHBvb2wgKMSRw6MgY2jhur90ISkKICAgIENPTk4teFM6IEhUVFAgUmVxdWVzdCAyCiAgICBOb3RlIG92ZXIgQ09OTjog4p2MIENvbm5lY3Rpb24gd2FzIGNsb3NlZAogICAgQ09OTi0tPj5DOiBJT0V4Y2VwdGlvbg?type=png)

**Request 1** Ä‘i qua ngon lÃ nh. Server xá»­ lÃ½, tráº£ response, rá»“i Ã¢m tháº§m Ä‘Ã³ng connection. Client khÃ´ng biáº¿t, nghÄ© connection váº«n sá»‘ng, cáº¥t vÃ o pool.

**Request 2** láº¥y Ä‘Ãºng connection Ä‘Ã³ ra. Cá»‘ gá»­i data qua má»™t Ä‘Æ°á»ng dÃ¢y Ä‘Ã£ cháº¿t. **BÃ¹m** - "Connection was closed".

---

## Táº¡i sao lá»—i nÃ y trá»‘n Ä‘Æ°á»£c 4 thÃ¡ng?

CÃ¢u há»i nÃ y Ã¡m áº£nh tÃ´i. Táº¡i sao UAT khÃ´ng phÃ¡t hiá»‡n?

**Thá»© nháº¥t, request Ä‘áº§u luÃ´n thÃ nh cÃ´ng.** Connection má»›i táº¡o thÃ¬ chÆ°a bá»‹ ai "giáº¿t". Náº¿u tester chá»‰ test má»™t request rá»“i nghá»‰, sáº½ khÃ´ng bao giá» tháº¥y lá»—i.

**Thá»© hai, traffic tháº¥p giÃºp che giáº¥u lá»—i.** Trong UAT, giá»¯a hai requests cÃ³ thá»ƒ cÃ¡ch nhau vÃ i giÃ¢y hoáº·c vÃ i phÃºt. Äá»§ thá»i gian Ä‘á»ƒ connection timeout vÃ  bá»‹ pool loáº¡i bá». LÃªn production, requests dá»“n dáº­p, connection "cháº¿t" Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng ngay láº­p tá»©c.

**Thá»© ba, restart "chá»¯a" Ä‘Æ°á»£c lá»—i.** Má»—i láº§n restart, pool Ä‘Æ°á»£c reset, connections má»›i Ä‘Æ°á»£c táº¡o. Lá»—i biáº¿n máº¥t... táº¡m thá»i. Äiá»u nÃ y khiáº¿n team nghÄ© Ä‘Ã³ lÃ  "lá»—i háº¡ táº§ng, restart lÃ  háº¿t".

ÄÃ¢y lÃ  bÃ i há»c Ä‘áº¯t giÃ¡ nháº¥t: **Äá»«ng bao giá» coi "restart lÃ  háº¿t" lÃ  giáº£i phÃ¡p.** Má»—i lá»—i Ä‘á»u cÃ³ nguyÃªn nhÃ¢n. Lá»—i hiáº¿m gáº·p cÃ³ thá»ƒ trá»Ÿ thÃ nh tháº£m há»a khi traffic tÄƒng.

---

## Fix vÃ  háº­u quáº£

Fix thÃ¬ Ä‘Æ¡n giáº£n - xÃ³a má»™t dÃ²ng code:

```java
// TrÆ°á»›c
response.end(result);
response.close();  // XÃ³a dÃ²ng nÃ y

// Sau
response.end(result);
// Vert.x tá»± quáº£n lÃ½ connection lifecycle
```

NhÆ°ng cÃ¢u chuyá»‡n chÆ°a káº¿t thÃºc. Sau khi tÃ¬m ra root cause, chÃºng tÃ´i grep toÃ n bá»™ codebase. VÃ  phÃ¡t hiá»‡n pattern nÃ y á»Ÿ **nhiá»u service khÃ¡c**.

Nhá»¯ng lá»—i "Connection lost" mÃ  Ä‘á»‘i tÃ¡c tá»«ng phÃ n nÃ n? CÃ³ láº½ cÃ¹ng nguyÃªn nhÃ¢n. Nhá»¯ng láº§n BE nÃ³i "khÃ´ng nháº­n Ä‘Æ°á»£c log"? Connection Ä‘Ã£ bá»‹ Ä‘Ã³ng trÆ°á»›c khi request Ä‘áº¿n.

Má»™t dÃ²ng code. Nhiá»u náº¡n nhÃ¢n. BÃ i há»c nhá»› Ä‘á»i.

---

## Náº¿u thá»±c sá»± cáº§n Ä‘Ã³ng connection thÃ¬ sao?

CÃ³ nhá»¯ng trÆ°á»ng há»£p hiáº¿m hoi báº¡n muá»‘n Ä‘Ã³ng connection - vÃ­ dá»¥ server chuáº©n bá»‹ shutdown. CÃ¡ch Ä‘Ãºng lÃ  **bÃ¡o cho client biáº¿t** thay vÃ¬ Ä‘Ã³ng báº¥t ngá»:

```java
response.putHeader("Connection", "close");  // BÃ¡o trÆ°á»›c
response.end(data);
// KHÃ”NG gá»i close() - client sáº½ tá»± Ä‘Ã³ng khi tháº¥y header
```

Header `Connection: close` nÃ³i vá»›i client: *"ÄÃ¢y lÃ  response cuá»‘i cÃ¹ng trÃªn connection nÃ y. HÃ£y Ä‘Ã³ng nÃ³ Ä‘i."* Client sáº½ khÃ´ng cáº¥t connection vÃ o pool, vÃ  táº¡o connection má»›i cho request sau.

---

## Káº¿t

3 giá» sÃ¡ng ngÃ y GiÃ¡ng sinh, sau 9 tiáº¿ng debug, chÃºng tÃ´i tÃ¬m ra thá»§ pháº¡m: má»™t dÃ²ng code.

```java
response.close();
```

ÄÃªm Ä‘Ã³ khÃ´ng cÃ³ tiá»‡c, khÃ´ng cÃ³ quÃ . NhÆ°ng team cÃ³ má»™t bÃ i há»c khÃ´ng thá»ƒ mua báº±ng tiá»n vá» HTTP Keep-Alive vÃ  Connection Pooling.

Anh Hiáº¿u nÃ³i Ä‘Ãºng: *"+1 kinh nghiá»‡m tráº£ lá»i phá»ng váº¥n."*

CÃ²n tÃ´i há»c Ä‘Æ°á»£c: Äá»«ng bao giá» bá» qua lá»—i "nhá»". Äá»«ng nghÄ© "restart lÃ  háº¿t". VÃ  Ä‘á»«ng "giÃºp" framework lÃ m nhá»¯ng viá»‡c nÃ³ Ä‘Ã£ lÃ m tá»‘t hÆ¡n báº¡n.

Merry Christmas. ğŸ„

---

## Äá»c thÃªm

- [HTTP Keep-Alive - MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Keep-Alive)
- [Vert.x HTTP Server](https://vertx.io/docs/vertx-core/java/#_writing_http_servers_and_clients)
- [Connection Pooling Best Practices](https://www.baeldung.com/java-connection-pooling)
