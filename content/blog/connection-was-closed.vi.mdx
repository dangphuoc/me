---
title: Connection Was Closed - ÄÃªm Noel khÃ´ng ngá»§
excerpt: CÃ¢u chuyá»‡n vá» má»™t dÃ²ng code tÆ°á»Ÿng chá»«ng vÃ´ háº¡i Ä‘Ã£ khiáº¿n cáº£ team thá»©c tráº¯ng Ä‘Ãªm GiÃ¡ng sinh. BÃ i há»c vá» connection pooling, HTTP keep-alive, vÃ  nhá»¯ng lá»—i nhá» bá»‹ bá» qua trong quÃ¡ trÃ¬nh tÃ­ch há»£p.
date: 2024-12-25
tags:
  - Debugging
  - Connection Pool
  - HTTP
  - Vert.x
  - Production Issue
thumbnail: https://images.unsplash.com/photo-1504639725590-34d0984388bd?w=800
---

# Connection Was Closed - ÄÃªm Noel khÃ´ng ngá»§

## Má»Ÿ Ä‘áº§u

**6 giá» tá»‘i, ngÃ y 24 thÃ¡ng 12.** Trong khi má»i ngÆ°á»i Ä‘ang chuáº©n bá»‹ cho Ä‘Ãªm GiÃ¡ng sinh, team chÃºng tÃ´i nháº­n Ä‘Æ°á»£c alert tá»« production: *"Connection was closed"* - hÃ ng loáº¡t giao dá»‹ch bá»‹ fail.

ÄÃ¢y lÃ  cÃ¢u chuyá»‡n vá» má»™t Ä‘Ãªm thá»©c tráº¯ng, tá»« 6 giá» tá»‘i Ä‘áº¿n 3 giá» sÃ¡ng, Ä‘á»ƒ sÄƒn tÃ¬m má»™t con bug tÆ°á»Ÿng chá»«ng Ä‘Æ¡n giáº£n nhÆ°ng láº¡i "chÃ­ máº¡ng".

> *"LÃ¢u lÃ¢u cÅ©ng tháº¥y cÃ³ lá»—i nÃ y, nhÆ°ng restart láº¡i lÃ  háº¿t..."* â€” Má»™t cÃ¢u nÃ³i quen thuá»™c mÃ  chÃºng tÃ´i Ä‘Ã£ bá» qua.

![Debugging at night](https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800)

---

## Bá»‘i cáº£nh

ChÃºng tÃ´i vá»«a hoÃ n thÃ nh **4 thÃ¡ng tÃ­ch há»£p** vá»›i má»™t Ä‘á»‘i tÃ¡c lá»›n. Há»‡ thá»‘ng cá»§a chÃºng tÃ´i Ä‘Ã³ng vai trÃ² **server**, Ä‘á»‘i tÃ¡c lÃ  **client** káº¿t ná»‘i vÃ o.

Trong quÃ¡ trÃ¬nh UAT, má»i thá»© cÃ³ váº» á»•n Ä‘á»‹nh. Thá»‰nh thoáº£ng cÃ³ lá»—i "Connection was closed", nhÆ°ng restart service lÃ  háº¿t. Team nghÄ© Ä‘Ã³ lÃ  váº¥n Ä‘á» háº¡ táº§ng, cÃ³ thá»ƒ do Kubernetes update gÃ¬ Ä‘Ã³.

**ÄÃ¢y chÃ­nh lÃ  Ä‘iá»ƒm "cháº¿t ngÆ°á»i":** Bá» qua nhá»¯ng lá»—i nhá», láº·p Ä‘i láº·p láº¡i.

Khi lÃªn production vá»›i lÆ°á»£ng giao dá»‹ch khá»•ng lá»“, lá»—i nÃ y xuáº¥t hiá»‡n ngÃ y cÃ ng nhiá»u. VÃ  Ä‘Ãªm GiÃ¡ng sinh, nÃ³ bÃ¹ng phÃ¡t.

---

## Cuá»™c Ä‘iá»u tra báº¯t Ä‘áº§u

### 12:25 AM - Loáº¡i trá»« kháº£ nÄƒng háº¡ táº§ng

> **Hiáº¿u:** *"Mai start cáº£ con adapter local luÃ´n. Äá»ƒ loáº¡i trá»« kháº£ nÄƒng do háº¡ táº§ng."*
>
> **NguyÃªn:** *"Em viáº¿t bÃªn ngoÃ i luÃ´n anh, tá»« ngay cÃ¡i resource, khÃ´ng Ä‘á»¥ng gÃ¬ tá»›i con máº¥y con heo khÃ¡c."*

ChÃºng tÃ´i quyáº¿t Ä‘á»‹nh cháº¡y service local Ä‘á»ƒ loáº¡i trá»« má»i yáº¿u tá»‘ háº¡ táº§ng - Kubernetes, sidecar, network policies...

### 12:28 AM - GPT nÃ³i cÃ³ thá»ƒ do K8s

> **TÃ´i:** *"NÃ£y research, con GPT nÃ³ nÃ³i cÃ³ thá»ƒ do k8s. Nhiá»u nguyÃªn nhÃ¢n. Mai add log trace thÃªm. Log mÃ¬nh Ä‘ang ko coi Ä‘Æ°á»£c Ä‘áº§y Ä‘á»§ láº¯m."*

ÄÃºng lÃ  cÃ³ nhiá»u bÃ i viáº¿t vá» Redis, database connection bá»‹ close do sidecar. NhÆ°ng linh cáº£m nÃ³i ráº±ng váº¥n Ä‘á» khÃ´ng náº±m á»Ÿ Ä‘Ã³.

### 12:31 AM - Manh má»‘i Ä‘áº§u tiÃªn

> **NguyÃªn:** *"Máº¥y request Ä‘áº§u khÃ´ng lá»—i. Sau má»™t khoáº£ng thá»i gian má»›i báº¯t Ä‘áº§u lá»—i anh."*

ÄÃ¢y lÃ  manh má»‘i quan trá»ng. Náº¿u lÃ  váº¥n Ä‘á» háº¡ táº§ng, lá»—i pháº£i xáº£y ra ngay tá»« Ä‘áº§u hoáº·c ngáº«u nhiÃªn. NhÆ°ng pattern nÃ y cho tháº¥y cÃ³ gÃ¬ Ä‘Ã³ tÃ­ch lÅ©y theo thá»i gian.

### 12:55 AM - Láº­p luáº­n sáº¯t Ä‘Ã¡

> **Hiáº¿u:** *"Issue server close connection lÃ  client submit lÃªn lÃ  nÃ³ vÄƒng exception ngay láº­p tá»©c. KhÃ´ng pháº£i Ä‘á»£i má»™t há»“i má»›i bá»‹ exception."*
>
> **Hiáº¿u:** *"Váº­y lÃ  bá»‹ server close connection, mÃ  cÃ¡i connection Ä‘Ã³ cÃ²n trong pool do TTL client lá»›n. Request tá»›i bÃ³c ra xÃ i, bÃ¹m... Connection was closed."*

**Bingo!** Láº­p luáº­n nÃ y giáº£i thÃ­ch má»i thá»©:

1. Server close connection sau má»—i request
2. Client khÃ´ng biáº¿t, váº«n giá»¯ connection trong pool
3. Request tiáº¿p theo láº¥y connection "cháº¿t" tá»« pool
4. **BÃ™M!** - "Connection was closed"

---

## PhÃ¢n tÃ­ch Root Cause

### Sequence Diagram

**Request 1 - ThÃ nh cÃ´ng:**

| BÆ°á»›c | Client (Connection Pool) | Connection | Server |
|------|--------------------------|------------|--------|
| 1 | Láº¥y connection tá»« pool | â†’ | |
| 2 | | HTTP Request 1 â†’ | Nháº­n request |
| 3 | | â† HTTP Response 1 | Gá»­i response |
| 4 | | â† **Close connection** | `response.close()` |
| 5 | Tráº£ vá» pool *(tÆ°á»Ÿng cÃ²n sá»‘ng)* | | |

**Request 2 - Lá»—i "Connection was closed":**

| BÆ°á»›c | Client (Connection Pool) | Connection | Server |
|------|--------------------------|------------|--------|
| 1 | Reuse connection tá»« pool | â†’ *(Ä‘Ã£ cháº¿t!)* | |
| 2 | | HTTP Request 2 â†’ | |
| 3 | | âŒ **Connection was closed** | |
| 4 | IOException! | | |

### Root Cause

| Component | Behavior | Váº¥n Ä‘á» |
|-----------|----------|--------|
| **Server** | Close connection sau má»—i request | `httpServerResponse.close()` |
| **Client** | Giá»¯ connection trong pool Ä‘á»ƒ reuse | TTL lá»›n, khÃ´ng biáº¿t Ä‘Ã£ bá»‹ close |
| **Káº¿t quáº£** | âš ï¸ **Mismatch configuration!** | Connection pool chá»©a "xÃ¡c cháº¿t" |

---

## 1:00 AM - Báº¯t Ä‘Æ°á»£c thá» con

> **TÃ´i:** *"áº¦y gÃ¹... `httpServerResponse.close();` - xÃ³a dÃ²ng Ä‘Ã³, start local, báº¯n 2 nÄƒm rá»“i chÆ°a lá»—i."*
>
> **NguyÃªn:** *"Váº­y lÃ  do chá»— con adapter háº£ anh? Tháº¿ thÃ¬ cháº¿t cÆ¡m luÃ´n!"*
>
> **Long:** *"ÄÃ³ng hÃ²m luÃ´n."*

Chá»‰ **má»™t dÃ²ng code**. Má»™t dÃ²ng `response.close()` tÆ°á»Ÿng chá»«ng vÃ´ háº¡i.

```java
// Code gÃ¢y ra váº¥n Ä‘á»
public void handleRequest(HttpServerRequest request) {
    // ... xá»­ lÃ½ business logic ...

    HttpServerResponse response = request.response();
    response.end(result);
    response.close();  // â† DÃ’NG NÃ€Y LÃ€ THá»¦ PHáº M!
}
```

### Táº¡i sao khÃ´ng cáº§n `close()`?

> **Hiáº¿u:** *"Má»›i há»i AI, nÃ³ kÃªu Ä‘Ã©o cáº§n close á»Ÿ server."*
>
> **TÃ´i:** *"ÄÃ¹a chá»© anh biáº¿t vá»¥ nÃ y, sau end khÃ´ng Ä‘Æ°á»£c close Ä‘Ã¢u."*

Khi báº¡n gá»i `response.end()`, Vert.x Ä‘Ã£:
- Gá»­i toÃ n bá»™ response vá» client
- Flush buffer
- Sáºµn sÃ ng cho request tiáº¿p theo (HTTP keep-alive)

Gá»i thÃªm `response.close()` sáº½ **Ä‘Ã³ng TCP connection**, phÃ¡ vá»¡ cÆ¡ cháº¿ keep-alive mÃ  client Ä‘ang dá»±a vÃ o.

```java
// Code Ä‘Ãºng
public void handleRequest(HttpServerRequest request) {
    // ... xá»­ lÃ½ business logic ...

    HttpServerResponse response = request.response();
    response.end(result);
    // KHÃ”NG Cáº¦N close() - Vert.x tá»± quáº£n lÃ½ connection
}
```

---

## Háº­u quáº£ lan rá»™ng

### 1:17 AM - PhÃ¡t hiá»‡n thÃªm náº¡n nhÃ¢n

> **NguyÃªn:** *"Luá»“ng VA cá»§a BVB, máº¥y anh bÃªn Ä‘Ã³ cÅ©ng raise lá»—i 500 hay 502 nhiá»u. CÃ³ khi nÃ o cÅ©ng Ä‘ang .close() khÃ´ng ta?"*
>
> **Long:** *"Em chá»£t nháº­n ra tháº±ng TCB cÅ©ng hay nÃ³i em nhÆ° váº­y."*

HÃ³a ra khÃ´ng chá»‰ má»™t service. Nhiá»u service khÃ¡c cÅ©ng cÃ³ thá»ƒ Ä‘ang "trÃºng Ä‘á»™c" bá»Ÿi cÃ¹ng pattern nÃ y.

> **Hiáº¿u:** *"Váº­y lÃ  Ã´ng cá»‘ ná»™i nÃ o khÃ´ng xÃ i pool thÃ¬ khÃ´ng bá»‹. CÃ²n xÃ i pool thÃ¬ Æ°ng cáº¯t. MÃ  Ä‘a sá»‘ tháº¿ giá»›i xÃ i pool."*

### 1:28 AM - Review code cÅ©

> **TÃ´i:** *"Xem code con transfer vÃ  nhá»› láº¡i máº¥y vá»¥ máº¥t káº¿t ná»‘i, mÃ  báº¥m vÃ´ vÄƒng luÃ´n. KhÃ´ng pháº£i timeout. DKM."*

Nhá»¯ng bug cÅ© mÃ  chÃºng tÃ´i tá»«ng gáº·p, nhá»¯ng láº§n client phÃ n nÃ n vá» "connection lost"... CÃ³ láº½ Ä‘á»u cÃ³ cÃ¹ng nguyÃªn nhÃ¢n.

---

## BÃ i há»c rÃºt ra

### 1. Äá»«ng bá» qua lá»—i "nhá»"

> *"LÃ¢u lÃ¢u cÅ©ng tháº¥y, restart lÃ  háº¿t"* - CÃ¢u nÃ³i nÃ y Ä‘Ã£ khiáº¿n chÃºng tÃ´i máº¥t má»™t Ä‘Ãªm GiÃ¡ng sinh.

Má»—i lá»—i Ä‘á»u cÃ³ nguyÃªn nhÃ¢n. Náº¿u lá»—i láº·p láº¡i, dÃ¹ hiáº¿m, hÃ£y Ä‘iá»u tra ngay. Äá»«ng Ä‘á»£i Ä‘áº¿n production.

### 2. Hiá»ƒu rÃµ connection lifecycle

| Method | Ã nghÄ©a |
|--------|---------|
| `response.end()` | Káº¿t thÃºc response, giá»¯ connection cho request tiáº¿p theo |
| `response.close()` | **ÄÃ³ng TCP connection**, client pháº£i táº¡o connection má»›i |

### 3. Connection Pool + Close = Tháº£m há»a

Khi server close connection mÃ  client khÃ´ng biáº¿t:
- Client váº«n giá»¯ "xÃ¡c cháº¿t" trong pool
- Request tiáº¿p theo láº¥y connection Ä‘Ã£ cháº¿t
- **Lá»—i ngay láº­p tá»©c**, khÃ´ng pháº£i timeout

### 4. Review code base khi phÃ¡t hiá»‡n pattern lá»—i

Má»™t bug á»Ÿ má»™t chá»— cÃ³ thá»ƒ tá»“n táº¡i á»Ÿ nhiá»u chá»— khÃ¡c. Khi tÃ¬m ra root cause, hÃ£y review toÃ n bá»™ codebase.

---

## Káº¿t luáº­n

> **NguyÃªn:** *"+1 bÃ i há»c Ä‘áº¯t giÃ¡ Ä‘Ãªm Noel."*
>
> **Hiáº¿u:** *"Anw, +1 kinh nghiá»‡m tráº£ lá»i phá»ng váº¥n. Nhá» vá»¥ nÃ y, cÅ©ng biáº¿t Ä‘Æ°á»£c nhiá»u thá»©."*

**3 giá» sÃ¡ng, ngÃ y 25 thÃ¡ng 12.** Sau 9 tiáº¿ng debug, chÃºng tÃ´i tÃ¬m ra thá»§ pháº¡m: **má»™t dÃ²ng code**.

```java
response.close();  // XÃ³a dÃ²ng nÃ y
```

ÄÃªm GiÃ¡ng sinh nÄƒm Ä‘Ã³, chÃºng tÃ´i khÃ´ng cÃ³ tiá»‡c, khÃ´ng cÃ³ quÃ . NhÆ°ng chÃºng tÃ´i cÃ³ má»™t bÃ i há»c quÃ½ giÃ¡ vá»:
- Connection pooling vÃ  HTTP keep-alive
- Táº§m quan trá»ng cá»§a viá»‡c khÃ´ng bá» qua lá»—i "nhá»"
- Sá»©c máº¡nh cá»§a teamwork khi debug production issue

> *"ThÃ´i chÃºc anh chá»‹ em Noel vui váº»!"* â€” 1:32 AM, sau khi tÃ¬m ra bug

**Happy debugging, vÃ  Merry Christmas!** ðŸŽ„

---

## TÃ i liá»‡u tham kháº£o

- [HTTP Keep-Alive](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Keep-Alive)
- [Vert.x HttpServerResponse](https://vertx.io/docs/apidocs/io/vertx/core/http/HttpServerResponse.html)
- [Connection Pooling Best Practices](https://www.baeldung.com/java-connection-pooling)
